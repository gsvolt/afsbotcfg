# OpenAFS Buildbot Configuration

## Introduction

This repository contains the Ansible playbook, configuration, and customization
for the [OpenAFS Buildbot Coordinator][2]. OpenAFS Buildbot hosting is
generously provided by MIT.

The `afsbotcfg.yml` playbook updates the buildbot coordinator.  This
playbook imports the `buildbot_master` role from the OpenAFS [Buildbot
Collection][4] to install and configure the buildbot coordinator.

User and worker passwords are encrypted with `ansible-vault`.  The buildbot
`master.cfg` file is generated by Ansible from the `master.cfg.j2` template
file.

Buildbot customization code is located in the `src/afsbotcfg` directory. The
playbook creates the `afsbotcfg` Python package from these source files and
installs the `afsbotcfg` package on the buildbot.

Podman containers are provided for running `ansible-playbook` and testing
on a local podman container.

## Requirements

* GNU Make
* podman
* The ansible vault key
* An ssh config and authorized key for the buildbot

The ansible vault key is used to encrypt the worker passwords. To run the playbook
with the podman container, this key must be added to a podman secret.

    $ make secret

## Running the playbook

Run `make test` to do a local lint check and playbook test on a local
container. (Currently, this requires the vault key.)

    $ make test

Run `make ping` to check ssh connectivity with the buildbot.

    $ make ping

Run `make deploy` to run the Ansible playbook to update the buildbot.

    $ make deploy

[1]: https://www.openafs.org/
[2]: https://buildbot.openafs.org/
[4]: https://galaxy.ansible.com/openafs_contrib/buildbot
