# OpenAFS Buildbot Configuration

## Introduction

This repository contains the Ansible playbook, configuration, and customization
for the [OpenAFS Buildbot Coordinator][2]. OpenAFS Buildbot hosting is
generously provided by MIT.

The `afsbotcfg.yml` playbook updates the buildbot coordinator.  This
playbook imports the `buildbot_master` role from the OpenAFS [Buildbot
Collection][4] to install and configure the buildbot coordinator.

User and worker passwords are encrypted with `ansible-vault`.  The buildbot
`master.cfg` file is generated by Ansible from the `master.cfg.j2` template
file.

Buildbot customization code is located in the `src/afsbotcfg` directory. The
playbook creates the `afsbotcfg` Python package from these source files and
installs the `afsbotcfg` package on the buildbot.

Podman containers are provided for running `ansible-playbook` and testing
on a local podman container.

## Requirements

* GNU Make
* podman
* The ansible vault key
* An ssh config and authorized key for the buildbot

The ansible vault key is used to encrypt the worker passwords. To run the playbook
with the podman container, this key must be added to a podman secret.

    $ make secret

## Testing the playbook

The playbook can be tested locally using podman and prebuild container images.
Buildbot credentials and the ansible vault key are not required to run the
local test.

The local test will create a podman pod, start containers to run the local
buildbot master in a container, run a set of containers to simulate the
buildbot workers, and run a container to simulate the Gerrit code review
system.

To create the pod and run the local test:

    make test

To remove the test containers:

    make clean

## Running the playbook

To check ssh connectivity with the buildbot:

    make ping

To run update the Buildbot master:

    make deploy


[1]: https://www.openafs.org/
[2]: https://buildbot.openafs.org/
[4]: https://galaxy.ansible.com/openafs_contrib/buildbot
